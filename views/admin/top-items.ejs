<!DOCTYPE html>
<html lang="en">
<head>
    <title>Top Selling Items</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <%- include('partials/head') %>
    <style>
        .chart-container {
            position: relative;
            height: 400px; /* Adjust the height to make the chart smaller */
            width: 400px;  /* Adjust the width to make the chart smaller */
        }
        .table-container {
            width: 100%;
        }
        .all-table {
            width: 100%;
            table-layout: auto;
        }
        .legend-container {
            display: flex;
            flex-wrap: wrap;
            margin-top: 10px;
        }
        .legend-item {
            display: flex;
            align-items: center;
            margin-right: 15px;
            margin-bottom: 10px;
        }
        .legend-color {
            width: 20px;
            height: 20px;
            margin-right: 5px;
        }
    </style>
</head>
<body>
    <div class="main-content">
        <div class="header">
            <div class="search-bar">
                <form action="/admin/search-user" method="GET">
                    <input type="text" name="search" placeholder="Search" readonly>
                    <button class="admin-search-button"><i class="fas fa-search"></i></button>
                </form>
            </div>
            <div class="admin-profile mx-3 mt-2">
                <a href="/admin/settings">
                    <i class="fa-solid fa-circle-user"></i>
                </a>
            </div>
        </div>
    
        <div class="breadcrumbs"><a href="/admin/top-items">Top Items</a></div>

        <div class="nav-buttons">
            <button onclick="showView('products')">Products</button>
            <!-- <button onclick="showView('productVariants')">Product Variants</button> -->
            <button onclick="showView('categories')">Categories</button>
            <button onclick="showView('subcategories')">Subcategories</button>
            <button onclick="showView('brands')">Brands</button>
        </div>
        
        <!-- Single Heading -->
        <h2 id="main-heading">Top 10 Best Selling Products</h2>
        
        <div id="products" class="content-container" style="display: flex;">
            <div class="table-container">
                <table class="all-table">
                    <thead>
                        <tr>
                            <th>Rank</th>
                            <th>Product Name</th>
                            <th>Total Sold</th>
                        </tr>
                    </thead>
                    <tbody id="productsTableBody">
                        <% topItems.products.forEach((item, index) => { %>
                        <tr>
                            <td><%= index + 1 %></td>
                            <td title="<%= item.name %>"><%= item.name %></td>
                            <td><%= item.totalSold %></td>
                        </tr>
                        <% }); %>
                    </tbody>
                </table>
            </div>
            <div class="chart-container">
                <canvas id="productsChart"></canvas>
                <div id="productsLegend" class="legend-container"></div>
            </div>
        </div>

        <div id="productVariants" class="content-container" style="display:none;">
            <div class="table-container">
                <table class="all-table">
                    <thead>
                        <tr>
                            <th>Rank</th>
                            <th>Variant Name</th>
                            <th>Total Sold</th>
                        </tr>
                    </thead>
                    <tbody id="productVariantsTableBody">
                        <% topItems.productVariants.forEach((item, index) => { %>
                        <tr>
                            <td><%= index + 1 %></td>
                            <td title="<%= item.title %>"><%= item.title %></td>
                            <td><%= item.soldCount %></td>
                        </tr>
                        <% }); %>
                    </tbody>
                </table>
            </div>
            <div class="chart-container">
                <canvas id="productVariantsChart"></canvas>
                <div id="productVariantsLegend" class="legend-container"></div>
            </div>
        </div>

        <div id="categories" class="content-container" style="display:none;">
            <div class="table-container">
                <table class="all-table">
                    <thead>
                        <tr>
                            <th>Rank</th>
                            <th>Category Name</th>
                            <th>Total Sold</th>
                        </tr>
                    </thead>
                    <tbody id="categoriesTableBody">
                        <% topItems.categories.forEach((item, index) => { %>
                        <tr>
                            <td><%= index + 1 %></td>
                            <td title="<%= item.name %>"><%= item.name %></td>
                            <td><%= item.totalSold %></td>
                        </tr>
                        <% }); %>
                    </tbody>
                </table>
            </div>
            <div class="chart-container">
                <canvas id="categoriesChart"></canvas>
                <div id="categoriesLegend" class="legend-container"></div>
            </div>
        </div>

        <div id="subcategories" class="content-container" style="display:none;">
            <div class="table-container">
                <table class="all-table">
                    <thead>
                        <tr>
                            <th>Rank</th>
                            <th>Subcategory Name</th>
                            <th>Total Sold</th>
                        </tr>
                    </thead>
                    <tbody id="subcategoriesTableBody">
                        <% topItems.subcategories.forEach((item, index) => { %>
                        <tr>
                            <td><%= index + 1 %></td>
                            <td title="<%= item.name %>"><%= item.name %></td>
                            <td><%= item.totalSold %></td>
                        </tr>
                        <% }); %>
                    </tbody>
                </table>
            </div>
            <div class="chart-container">
                <canvas id="subcategoriesChart"></canvas>
                <div id="subcategoriesLegend" class="legend-container"></div>
            </div>
        </div>

        <div id="brands" class="content-container" style="display:none;">
            <div class="table-container">
                <table class="all-table">
                    <thead>
                        <tr>
                            <th>Rank</th>
                            <th>Brand Name</th>
                            <th>Total Sold</th>
                        </tr>
                    </thead>
                    <tbody id="brandsTableBody">
                        <% topItems.brands.forEach((item, index) => { %>
                        <tr>
                            <td><%= index + 1 %></td>
                            <td title="<%= item.name %>"><%= item.name %></td>
                            <td><%= item.totalSold %></td>
                        </tr>
                        <% }); %>
                    </tbody>
                </table>
            </div>
            <div class="chart-container">
                <canvas id="brandsChart"></canvas>
                <div id="brandsLegend" class="legend-container"></div>
            </div>
        </div>
    </div>

    <script>
        // Embed the data directly into the script
        const topItems = <%- JSON.stringify(topItems) %>;

        function renderChart(chartId, title, data, labelKey = 'name') {
            const ctx = document.getElementById(chartId).getContext('2d');
            const chart = new Chart(ctx, {
                type: 'doughnut', // Changed to doughnut for all charts
                data: {
                    labels: data.map(item => item[labelKey]),
                    datasets: [{
                        label: title,
                        data: data.map(item => item.totalSold),
                        backgroundColor: [
                            '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40',
                            '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0'
                        ],
                        hoverBackgroundColor: [
                            '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40',
                            '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false // Disable default legend
                        }
                    }
                }
            });

            // Create custom legend
            const legendContainer = document.getElementById(chartId.replace('Chart', 'Legend'));
            legendContainer.innerHTML = chart.data.labels.map((label, index) => `
                <div class="legend-item">
                    <div class="legend-color" style="background-color: ${chart.data.datasets[0].backgroundColor[index]}"></div>
                    <span>${label}</span>
                </div>
            `).join('');

            // Color the table rows
            const tableBody = document.getElementById(chartId.replace('Chart', 'TableBody'));
            const rows = tableBody.querySelectorAll('tr');
            rows.forEach((row, index) => {
                row.style.backgroundColor = chart.data.datasets[0].backgroundColor[index];
            });
        }

        function showView(viewId) {
            const contentContainers = document.querySelectorAll('.content-container');
            const mainHeading = document.getElementById('main-heading');
            const viewNames = {
                'products': 'Top 10 Best Selling Products',
                'productVariants': 'Top 10 Best Selling Product Variants',
                'categories': 'Top 10 Best Selling Categories',
                'subcategories': 'Top 10 Best Selling Subcategories',
                'brands': 'Top 10 Best Selling Brands'
            };

            mainHeading.textContent = viewNames[viewId];

            contentContainers.forEach(container => {
                if (container.id === viewId) {
                    container.style.display = 'flex';
                } else {
                    container.style.display = 'none';
                }
            });

            renderChart(viewId + "Chart", viewNames[viewId], topItems[viewId], viewId === 'productVariants' ? 'title' : 'name');
        }

        // Show the first view by default
        showView('products');
    </script>
    
    <%- include('partials/footer') %>
</body>
</html>