<!DOCTYPE html>
<html lang="en">
<%- include('partials/head') %>
<div class="main-content">
  <div class="header">
    <div class="search-bar">
      <form action="/search-category" method="GET">
        <input type="text" name="search" placeholder="Search User" disabled>
        <button class="admin-search-button" disabled><i class="fas fa-search"></i></button>
      </form>
    </div>
    <div class="admin-profile mx-3">
      <a href="/settings">
        <i class="fa-solid fa-circle-user"></i>
      </a>
    </div>
  </div>
  <div class="brudcrumbs"><a href="/orderlists">Order lists</a></div>
  <div class="filter-container">
    <div class="filter-div1">
      <div class="filter-box">
        <i class="fa-solid fa-filter"></i>
      </div>

      <form action="/users" method="GET">
        <div class="filter-box">
          <label for="filter">Filter By
            <select name="filter" id="filter">
              <option value="date">14 feb 2014</option>
            </select>
          </label>
        </div>
      </form>
      <form action="/admin/orderlists" method="GET">
        <div class="filter-box">
            <label for="status">Status
                <select name="status" id="status" onchange="this.form.submit()">
                    <option value="all" <%= status === 'all' ? 'selected' : '' %>>All</option>
                    <option value="pending" <%= status === 'pending' ? 'selected' : '' %>>Pending</option>
                    <option value="processing" <%= status === 'processing' ? 'selected' : '' %>>Processing</option>
                    <option value="shipped" <%= status === 'shipped' ? 'selected' : '' %>>Shipped</option>
                    <option value="delivered" <%= status === 'delivered' ? 'selected' : '' %>>Delivered</option>
                    <option value="canceled" <%= status === 'canceled' ? 'selected' : '' %>>Canceled</option>
                    <option value="return_req" <%= status === 'return_requested' ? 'selected' : '' %>>Return Requested</option>
                    <option value="returned" <%= status === 'returned' ? 'selected' : '' %>>Returned</option>
                </select>
            </label>
        </div>
    </form>
    
    
    
    </div>


  </div>

  <table class="all-table">
    <thead>
      <tr>
        <th>S.No</th>
        <th>Order ID</th>
        <th>User Name</th>
        <th>Address</th>
        <th>Product Name</th>
        <th>Quantity</th>
        <th>Total Amount</th>
        <th>Order Status</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody>
      <% let serialNumber = (currentPage - 1) * 10; %>
      <% orders.forEach((order) => { %>
        <tr class="order-row" id="order-<%= order.orderId %>-product-<%= order.product._id %>">
          <td><%= ++serialNumber %></td>
          <td><%= order.orderId %></td>
          <td><%= order.userId.name %></td>
          <td><%= order.addressId.city %>, <%= order.addressId.state %></td>
          <td>
            <img src="/uploads/<%= encodeURIComponent(order.product.product_imgs[0]) %>" alt="<%= order.product.title %>" width="45" height="45" style="margin-right: 10px; vertical-align: middle;">
            <%= order.product.title.slice(0, 20) %>...
          </td>
          <td><%= order.quantity %></td>
          <td>â‚¹<%= order.totalAmount %></td>
          <td class="status-cell">
            <p2 class="m-0 mb-4 
                <% if (order.status === 'pending') { %> yellow-p <% } %>
                <% if (order.status === 'processing') { %> blue-p <% } %>
                <% if (order.status === 'shipped') { %> pink-p <% } %>
                <% if (order.status === 'delivered') { %> green-p <% } %>
                <% if (order.status === 'canceled') { %> red-p <% } %>
                <% if (order.status === 'return_req') { %> yellow-p <% } %>
                <% if (order.status === 'returned') { %> blue-p <% } %>">
              <%= order.status %>
            </p2>
          </td>
          <td>
            <select name="order-action" class="order-action" data-product-id="<%= order.product._id %>" data-order-id="<%= order.orderId %>">
              <option value="pending" <%= order.status === 'pending' ? 'selected' : '' %>>pending</option>
              <option value="processing" <%= order.status === 'processing' ? 'selected' : '' %>>processing</option>
              <option value="shipped" <%= order.status === 'shipped' ? 'selected' : '' %>>shipped</option>
              <option value="delivered" <%= order.status === 'delivered' ? 'selected' : '' %>>delivered</option>
              <option value="canceled" <%= order.status === 'canceled' ? 'selected' : '' %>>canceled</option>
              <option value="returned" <%= order.status === 'returned' ? 'selected' : '' %>>returned</option>
            </select>
          </td>
        </tr>
      <% }) %>
    </tbody>
  </table>

</div>

<div class="pagination">
    <% if (currentPage > 1) { %>
        <a href="/admin/orderlists?page=<%= currentPage - 1 %>&status=<%= status %>">Previous</a>
    <% } %>

    <% for (let i = 1; i <= totalPages; i++) { %>
        <a href="/admin/orderlists?page=<%= i %>&status=<%= status %>" class="<%= currentPage === i ? 'active' : '' %>"><%= i %></a>
    <% } %>

    <% if (currentPage < totalPages) { %>
        <a href="/admin/orderlists?page=<%= currentPage + 1 %>&status=<%= status %>">Next</a>
    <% } %>
</div>




</body>
<%- include('partials/footer') %>
<script>
document.addEventListener("DOMContentLoaded", function () {
  const notyf = new Notyf({
    duration: 1500,
    ripple: true,
    position: { x: "right", y: "top" },
    dismissible: true,
    types: [
      { type: "success", background: "green" },
      { type: "error", background: "red" },
    ],
  });

  const dropdowns = document.querySelectorAll(".order-action");
  dropdowns.forEach(function (dropdown) {
    dropdown.addEventListener("change", function () {
      const selectedValue = this.value;
      const productId = this.getAttribute("data-product-id");
      const orderId = this.getAttribute("data-order-id");
      const statusCell = this.closest("tr").querySelector(".status-cell");

      const data = {
        productId: productId,
        orderId: orderId,
        status: selectedValue,
      };

      fetch("/update-order-status", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify(data),
      })
        .then((response) => response.json())
        .then((data) => {
          if (data.success) {
            notyf.success(data.message);
            statusCell.textContent = selectedValue;
            statusCell.classList.remove("yellow-p", "blue-p", "pink-p", "green-p", "red-p");
            statusCell.classList.add(getStatusClass(selectedValue));
          } else {
            notyf.error(data.message);
          }
        })
        .catch((error) => console.error(error));
    });
  });
});

function getStatusClass(status) {
  const statusClasses = {
    pending: "yellow-p",
    processing: "blue-p",
    shipped: "pink-p",
    delivered: "green-p",
    canceled: "red-p",
    return_requested: "yellow-p",
    returned: "blue-p",
  };
  return statusClasses[status] || "";
}


</script>
</html>