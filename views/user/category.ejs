<!DOCTYPE html>
<html lang="en">
<%- include('partials/headforhome', { name: name, categories: categories }) %>

<div class="user-contents">

  <div class="container  mt-4">
    <div class="row">
      <div class="col-md-2 product-filter-div p-0">
        <form id="filter-form">
          <div class="filter-item">
            <hr>
            <div class="filter-header d-flex justify-content-between align-items-center" data-filter="popularity">
              <span>Popularity</span>
              <i class="fa-solid fa-chevron-down"></i>
            </div>
            <div class="filter-options" id="popularity-options" style="display: none;">
              <div>
                <label class="d-flex justify-content-between align-items-center px-2 py-1" for="trending">
                  Trending
                  <input type="checkbox" name="popularity" value="trending" id="trending">
                </label>
              </div>
              <div>
                <label class="d-flex justify-content-between align-items-center px-2 py-1" for="most-reviewed">
                  Most Reviewed
                  <input type="checkbox" name="popularity" value="most-reviewed" id="most-reviewed">
                </label>
              </div>
              <div>
                <label class="d-flex justify-content-between align-items-center px-2 py-1" for="top-rated">
                  Top Rated
                  <input type="checkbox" name="popularity" value="top-rated" id="top-rated">
                </label>
              </div>
            </div>
          </div>

          <!-- Category Filter -->
          <div class="filter-item">
            <hr>
            <div class="filter-header d-flex justify-content-between align-items-center" data-filter="category">
              <span>Category</span>
              <i class="fa-solid fa-chevron-down"></i>
            </div>
            <div class="filter-options" id="category-options" style="display: none;">
              <% categories.forEach(category => { %>
              <div class="d-flex align-items-center justify-content-between px-2 py-1">
                <label for="category-<%= category.id %>"><%= category.name %></label>
                <input type="checkbox" class="ml-auto category-checkbox" id="category-<%= category.id %>" name="category" value="<%= category.id %>" data-name="<%= category.name %>" />
              </div>
              <% }) %>
            </div>
          </div>

          <!-- Subcategory Filter -->
          <div class="filter-item">
            <hr>
            <div class="filter-header d-flex justify-content-between align-items-center" data-filter="subcategory">
              <span>Subcategory</span>
              <i class="fa-solid fa-chevron-down"></i>
            </div>
            <div class="filter-options" id="subcategory-options" style="display: none;">
              <% subcategories.forEach(subcategory => { %>
              <div class="d-flex align-items-center justify-content-between px-2 py-1">
                <label for="subcategory-<%= subcategory.id %>"><%= subcategory.name %></label>
                <input type="checkbox" class="ml-auto subcategory-checkbox" id="subcategory-<%= subcategory.id %>" name="subcategory" value="<%= subcategory.id %>" data-name="<%= subcategory.name %>" />
              </div>
              <% }) %>
            </div>
          </div>

          <!-- Brand Filter -->
          <div class="filter-item">
            <hr>
            <div class="filter-header d-flex justify-content-between align-items-center" data-filter="brand">
              <span>Brand</span>
              <i class="fa-solid fa-chevron-down"></i>
            </div>
            <div class="filter-options" id="brand-options" style="display: none;">
              <% brands.forEach(brand => { %>
              <div class="d-flex align-items-center justify-content-between px-2 py-1">
                <label for="brand-<%= brand.id %>"><%= brand.brandName %></label>
                <input type="checkbox" class="ml-auto brand-checkbox" id="brand-<%= brand.id %>" name="brand" value="<%= brand.id %>" data-name="<%= brand.brandName %>" />
              </div>
              <% }) %>
            </div>
          </div>

          <!-- Additional Filters (Price, Rating, etc.) -->
          <div class="filter-item">
            <hr>
            <div class="filter-header d-flex justify-content-between align-items-center" data-filter="price">
              <span>Price</span>
              <i class="fa-solid fa-chevron-down"></i>
            </div>
            <div class="filter-options" id="price-options" style="display: none;">
              <div>
                <label class="d-flex justify-content-between align-items-center px-2 py-1" for="low-to-high">
                  Low to High
                  <input type="checkbox" name="price" value="low-to-high" id="low-to-high">
                </label>
              </div>
              <div>
                <label class="d-flex justify-content-between align-items-center px-2 py-1" for="high-to-low">
                  High to Low
                  <input type="checkbox" name="price" value="high-to-low" id="high-to-low">
                </label>
              </div>
            </div>
          </div>

          <!-- Additional Filters (Rating, Alphabetical Sort, etc.) -->
          <div class="filter-item">
            <hr>
            <div class="filter-header d-flex justify-content-between align-items-center" data-filter="average-rating">
              <span>Average Rating</span>
              <i class="fa-solid fa-chevron-down"></i>
            </div>
            <div class="filter-options" id="average-rating-options" style="display: none;">
              <div>
                <label class="d-flex justify-content-between align-items-center px-2 py-1" for="rating-5">
                  5 Stars
                  <input type="checkbox" name="rating" value="5" id="rating-5">
                </label>
              </div>
              <div>
                <label class="d-flex justify-content-between align-items-center px-2 py-1" for="rating-4">
                  4 Stars
                  <input type="checkbox" name="rating" value="4" id="rating-4">
                </label>
              </div>
              <div>
                <label class="d-flex justify-content-between align-items-center px-2 py-1" for="rating-3">
                  3 Stars
                  <input type="checkbox" name="rating" value="3" id="rating-3">
                </label>
              </div>
              <div>
                <label class="d-flex justify-content-between align-items-center px-2 py-1" for="rating-2">
                  2 Stars
                  <input type="checkbox" name="rating" value="2" id="rating-2">
                </label>
              </div>
              <div>
                <label class="d-flex justify-content-between align-items-center px-2 py-1" for="rating-1">
                  1 Star
                  <input type="checkbox" name="rating" value="1" id="rating-1">
                </label>
              </div>
            </div>
          </div>

          <!-- Filter Item: Alphabetical Sort -->
          <div class="filter-item">
            <hr>
            <div class="filter-header d-flex justify-content-between align-items-center" data-filter="alphabetical">
              <span>Sort Alphabetically</span>
              <i class="fa-solid fa-chevron-down"></i>
            </div>
            <div class="filter-options" id="alphabetical-options" style="display: none;">
              <div>
                <label class="d-flex justify-content-between align-items-center px-2 py-1" for="alphabetical-a-z">
                  A-Z
                  <input type="checkbox" name="alphabetical" value="a-z" id="alphabetical-a-z">
                </label>
              </div>
              <div>
                <label class="d-flex justify-content-between align-items-center px-2 py-1" for="alphabetical-z-a">
                  Z-A
                  <input type="checkbox" name="alphabetical" value="z-a" id="alphabetical-z-a">
                </label>
              </div>
            </div>
          </div>

          <!-- Filter Item: New Arrivals -->
          <div class="filter-item">
            <hr>
            <div class="filter-header d-flex justify-content-between align-items-center" data-filter="new-arrivals">
              <span>New Arrivals</span>
              <i class="fa-solid fa-chevron-down"></i>
            </div>
            <div class="filter-options" id="new-arrivals-options" style="display: none;">
              <div>
                <label class="d-flex justify-content-between align-items-center px-2 py-1" for="new-arrivals-latest">
                  Latest
                  <input type="checkbox" name="new-arrivals" value="latest" id="new-arrivals-latest">
                </label>
              </div>
              <div>
                <label class="d-flex justify-content-between align-items-center px-2 py-1" for="new-arrivals-oldest">
                  Oldest
                  <input type="checkbox" name="new-arrivals" value="oldest" id="new-arrivals-oldest">
                </label>
              </div>
            </div>
            <hr>
          </div>
        </form>
      </div>


      <div class="col-md-10 ps-4 pe-0">
        <div class="product-grid">
          <% products.forEach(product => { %>
          <div class="product-card">
            <a href="/product/<%= product._id %>">
              <img src="/uploads/<%= encodeURIComponent(product.product_imgs[0]) %>" />
            </a>
            <div class="product-card-like">
              <form action="/add-to-wishlist/<%= product._id %>" method="POST" class="wishlist-form" id="wishlist-form">
                <% if (user) { %>
                <% if (wishlist && wishlist.products && wishlist.products.some(item => item.product_id._id.toString() === product._id.toString())) { %>
                <!-- Button to remove product from wishlist -->
                <button type="submit" title="Remove from Wishlist" class="wishlist-button">
                  <i class="fa-solid fa-heart in-wishlist"></i>
                </button>
                <% } else { %>
                <!-- Button to add product to wishlist -->
                <button type="submit" title="Add to Wishlist" class="wishlist-button">
                  <i class="fa-solid fa-heart not-in-wishlist"></i>
                </button>
                <% } %>
                <% } else { %>
                <!-- Button for users not logged in -->
                <button type="button" title="Login to Add to Wishlist" class="wishlist-button" onclick="window.location.href='/login'">
                  <i class="fa-solid fa-heart"></i>
                </button>
                <% } %>
              </form>
            </div>
            <a href="/product/<%= product._id %>">
              <p class="product-title"><%= product.title %></p>
            </a>
            <div class="product-prices-box">
              <p class="sale-price price-inr">&#8377;<%= product.price %></p>
              <p class="original-price price-inr mx-2">&#8377;<%= product.sales_price %></p>
              <!-- <p class="product-rating">★★★★☆</p> -->
              <% if (product.price > product.sales_price) { %>
              <span class="discount-percentage">
                <%= Math.round(((product.price - product.sales_price) / product.price) * 100) %>% Off
              </span>
              <% } %>
            </div>
            <form action="/add-to-cart/<%= product._id %>" method="POST" class="cart-form" id="cart-form">
              <button type="submit" class="add-to-cart-btn" data-id="<%= product._id %>">Add to Bag</button>
            </form>
          </div>
          <% }) %>
        </div>

      </div>
    </div>
  </div>



  <!-- <div id="cart-notification" class="notification">Cart Notification</div> -->

</div>



<div id="wishlist-notification" class="wishlist-notification">
  <i class="fas fa-check-circle"></i>&nbsp;&nbsp;
  <p id="wishlist-notification">Product has been added to Wishlist.</p>
</div>



</body>
<%- include('partials/footerforhome') %>

<script>
  window.onload = function() {
    window.scrollTo(0, 0);
  };
  const notyf = new Notyf({
    duration: 2000,
    ripple: true,
    position: {
      x: 'right',
      y: 'bottom'
    },
    types: [{
        type: 'success',
        background: 'green'
      },
      {
        type: 'error',
        background: 'red'
      },
    ],
    className: 'custom-notify',
  });

  document.addEventListener('DOMContentLoaded', function() {
    const priceElements = document.querySelectorAll('.price-inr');

    priceElements.forEach(element => {
      const price = parseInt(element.textContent.replace(/[^0-9]/g, ''), 10);
      element.textContent = '₹ ' + price.toLocaleString('en-IN');
    });
  });
  document.addEventListener('DOMContentLoaded', () => {
    const forms = document.querySelectorAll('.wishlist-form');
    const notification = document.querySelector('.wishlist-notification');

    forms.forEach(form => {
      form.addEventListener('submit', function(event) {
        event.preventDefault(); // Preventing Peage Refresh 

        const button = form.querySelector('button');
        const icon = button.querySelector('i');
        const productId = form.action.split('/').pop();
        const url = form.action;

        fetch(url, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              product_id: productId
            }),
          })
          .then(response => response.json())
          .then(data => {

            if (data.action === 'added') {
              icon.classList.remove('not-in-wishlist');
              icon.classList.add('in-wishlist');
              button.title = 'Remove from Wishlist';

              notification.innerHTML = `
                            <i class="fas fa-check-circle"></i>&nbsp;&nbsp;
                            <p>Product has been added to Wishlist.</p>
                        `;
              notification.classList.add('show');

              setTimeout(() => {
                notification.classList.remove('show');
              }, 3000);
            } else if (data.action === 'removed') {
              icon.classList.remove('in-wishlist');
              icon.classList.add('not-in-wishlist');
              button.title = 'Add to Wishlist';

              notification.innerHTML = `
                            <i class="fas fa-check-circle"></i>&nbsp;&nbsp;
                            <p>Product has been removed from Wishlist.</p>
                        `;
              notification.classList.add('show');

              setTimeout(() => {
                notification.classList.remove('show');
              }, 3000);
            }
          })
          .catch(error => {
            console.error('Error:', error);
          });
      });
    });
  });

  document.querySelectorAll('.add-to-cart-btn').forEach(button => {
    button.addEventListener('click', (event) => {
      event.preventDefault();
      const productId = event.target.dataset.id;
      const quantity = 1;

      if ('<%= user %>') {
        fetch(`/add-to-cart/${productId}`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              quantity
            })
          })
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              notyf.success(data.message);
            } else {
              notyf.error(data.message);
            }
          })
          .catch(error => {
            console.error('Error:', error);
            notyf.error('An error occurred while adding the product to the cart.');
          });
      } else {
        const cart = JSON.parse(localStorage.getItem('cart')) || [];
        const existingItem = cart.find(item => item.productId === productId);

        if (existingItem) {
          existingItem.quantity += quantity;
        } else {
          cart.push({
            productId,
            quantity
          });
        }

        localStorage.setItem('cart', JSON.stringify(cart));
        notyf.success('Product added to cart!');
      }
    });
  });


  function showCartNotification(message) {
    const notification = document.getElementById('cart-notification');
    notification.textContent = message;
    notification.classList.add('show');

    setTimeout(() => {
      notification.classList.remove('show');
    }, 3000);
  }

  let filters = {}

  function handleCheckboxChange(event) {
  const checkbox = event.target;
  const filterType = checkbox.name;
  const filterValue = checkbox.value;
  const isChecked = checkbox.checked;

  if (isChecked) {
    if (!filters[filterType]) {
      filters[filterType] = [];
    }
    filters[filterType].push(filterValue);
  } else {
    filters[filterType] = filters[filterType].filter(value => value !== filterValue);
    if (filters[filterType].length === 0) {
      delete filters[filterType];
    }
  }

  console.log("Updated Filters:", filters);

  const payload = {
    filters: filters
  };

  fetch('/product-Page-filters', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify(payload),
    })
    .then(response => response.json())
    .then(data => {
      console.log('Filtered products:', data);
      updateProductGrid(data.products, data.wishlist, data.user); 
    })
    .catch(error => {
      console.error("Error fetching filtered products:", error);
    });
}

function updateProductGrid(products, wishlist, user) {
  const productGrid = document.querySelector('.product-grid');
  productGrid.innerHTML = ''; 

  products.forEach(product => {
    const isProductInWishlist = wishlist && wishlist.products && wishlist.products.some(item => item.product_id._id.toString() === product._id.toString());

    const productCard = `
      <div class="product-card">
        <a href="/product/${product._id}">
          <img src="/uploads/${encodeURIComponent(product.product_imgs[0])}" />
        </a>

        <div class="product-card-like">
          <form action="/add-to-wishlist/${product._id}" method="POST" class="wishlist-form">
            ${user ? ` 
              ${isProductInWishlist ? `
                <button type="submit" title="Remove from Wishlist" class="wishlist-button">
                  <i class="fa-solid fa-heart in-wishlist"></i>
                </button>
              ` : `
                <button type="submit" title="Add to Wishlist" class="wishlist-button">
                  <i class="fa-solid fa-heart not-in-wishlist"></i>
                </button>
              `}
            ` : `
              <button type="button" title="Login to Add to Wishlist" class="wishlist-button" onclick="window.location.href='/login'">
                <i class="fa-solid fa-heart"></i>
              </button>
            `}
          </form>
        </div>

        <a href="/product/${product._id}">
          <p class="product-title">${product.title}</p>
        </a>

        <div class="product-prices-box">
          <p class="sale-price price-inr">&#8377;${product.price}</p>
          <p class="original-price price-inr mx-2">&#8377;${product.sales_price}</p>
          ${product.price > product.sales_price ? `<span class="discount-percentage">${Math.round(((product.price - product.sales_price) / product.price) * 100)}% Off</span>` : ''}
        </div>

        <form action="/add-to-cart/${product._id}" method="POST" class="cart-form" id="cart-form">
          <button type="submit" class="add-to-cart-btn" data-id="${product._id}">Add to Bag</button>
        </form>
      </div>
    `;
    productGrid.innerHTML += productCard;
  });
}
document.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
  checkbox.addEventListener('change', handleCheckboxChange);
});

  // Toggling visibility for filter options
  document.querySelectorAll('.filter-header').forEach(header => {
    header.addEventListener('click', () => {
      const options = header.nextElementSibling;
      options.style.display = options.style.display === 'none' ? 'block' : 'none';
      header.querySelector('i').classList.toggle('fa-chevron-down');
      header.querySelector('i').classList.toggle('fa-chevron-up');
    });
  });
</script>

</html>